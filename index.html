<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Attendance Dashboard</title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --light-grey: #f4f7f9;
            --dark-grey: #6c757d;
            --border-color: #e9ecef;
            --card-bg: #ffffff;
            --text-color: #343a40;
            --header-color: #1c294e;
            --safe-color: #28a745;
            --safe-bg: #e9f7ec;
            --warning-color: #dc3545;
            --warning-bg: #fbebee;
            --info-color: #17a2b8;
            --info-bg: #e7f6f8;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-grey);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 900px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
            box-sizing: border-box;
        }
        header { 
            text-align: center; 
            margin-bottom: 25px; 
        }
        header h1 { 
            color: var(--header-color); 
            margin-bottom: 5px;
        }
        header p { 
            color: var(--dark-grey); 
            margin-top: 0; 
        }
        .input-section {
            background-color: #f8f9fa; 
            border: 1px solid var(--border-color); 
            border-radius: 8px;
            padding: 20px; 
            margin-bottom: 25px; 
            display: flex; 
            flex-wrap: wrap;
            gap: 20px; 
            align-items: flex-end;
        }
        .input-group { 
            flex: 1; 
            min-width: 200px; 
        }
        label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 8px; 
            color: #555; 
        }
        input[type="number"], .input-style { /* Added .input-style here */
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ced4da;
            border-radius: 6px; 
            font-size: 16px; 
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="number"]:focus, .input-style:focus { 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); 
            outline: none; 
        }
        button {
            padding: 12px 20px; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px;
            font-weight: 600; 
            cursor: pointer; 
            transition: background-color 0.2s, transform 0.1s;
        }
        button:active { 
            transform: scale(0.98); 
        }
        .btn-primary { 
            background-color: var(--primary-color); 
            color: white; 
            flex-shrink: 0; 
        }
        .btn-primary:hover { 
            background-color: var(--primary-dark); 
        }
        .btn-secondary { /* Added for calendar buttons */
            background-color: var(--dark-grey);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
    
        .dashboard { 
            display: none; /* Hidden by default, shown when dashboard is generated */
            grid-template-columns: 1fr 1fr; 
            gap: 25px; 
        }
        .card { 
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Softer shadow for cards */
        }
        .card h3 { 
            margin-top: 0; 
            border-bottom: 2px solid var(--light-grey); 
            padding-bottom: 10px; 
            margin-bottom: 15px; 
            display:flex; 
            align-items:center; 
            gap: 10px; 
            font-size: 1.2em; /* Slightly smaller heading */
        }

        /* Gauge Infographic */
        .gauge-container { 
            position: relative; 
            width: 200px; 
            height: 100px; 
            margin: 20px auto; 
            overflow: hidden; 
        }
        .gauge-svg { 
            width: 200px; 
            height: 100px; 
        }
        .gauge-back { 
            fill: none; 
            stroke: #eee; 
            stroke-width: 20; 
        }
        .gauge-front { 
            fill: none; 
            stroke: var(--primary-color); 
            stroke-width: 20; 
            stroke-linecap: round; 
            transition: stroke-dashoffset 1s ease-in-out, stroke 1s; 
        }
        .gauge-text { 
            position: absolute; 
            top: 65%; /* Adjusted position slightly */
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 2.2em; /* Adjusted font size */
            font-weight: 700; 
            color: var(--header-color); 
        }
        .gauge-subtext { 
            text-align: center; 
            font-size: 0.9em; /* Slightly smaller */
            color: var(--dark-grey); 
            margin-top: -5px; /* Adjust spacing */
        }

        /* Analysis Card */
        .analysis-item { 
            margin-bottom: 15px; 
        }
        .analysis-item strong { 
            color: var(--header-color); 
        }
        .progress-bar { 
            width: 100%; 
            background-color: var(--border-color); 
            border-radius: 5px; 
            height: 10px; 
            overflow: hidden; 
        }
        .progress-bar-inner { 
            height: 100%; 
            background-color: var(--warning-color); 
            border-radius: 5px; 
            transition: width 1s ease-in-out; 
        }
        .insight { 
            background: var(--info-bg); 
            border-left: 4px solid var(--info-color); 
            padding: 15px; 
            border-radius: 4px; 
            margin-top: 20px; 
            font-size: 0.9em; 
        }
    
        /* Subject Breakdown */
        .subject-breakdown { 
            display: grid; 
            gap: 10px; 
        }
        .subject-row { 
            display: grid; 
            grid-template-columns: 100px 1fr 50px; 
            align-items: center; 
            gap: 10px; 
            font-size: 0.9em; 
        }
        .subject-bar-container { 
            background-color: var(--light-grey); 
            border-radius: 4px; 
            overflow:hidden; 
        }
        .subject-bar { 
            height: 18px; 
            background-color: var(--primary-color); 
            border-radius: 4px; 
            transition: width 1s ease-in-out; 
        }
        .subject-bar.safe { 
            background-color: var(--safe-color); 
        }
        .subject-bar.warning { 
            background-color: var(--warning-color); 
        }

        /* Calendar and Simulation */
        .calendar-container { 
            text-align: center; 
        }
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        #monthYear { 
            font-size: 1.2em; 
            font-weight: 600; 
            color: var(--header-color); 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 5px; 
        }
        .day-name { 
            font-weight: 600; 
            font-size: 0.9em; 
            color: var(--dark-grey); 
        }
        .calendar-day { 
            padding: 8px 5px; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: auto; 
            cursor: pointer; 
            transition: all 0.2s; 
            border: 1px solid transparent; /* Add border for consistent hover */
        }
        .calendar-day:not(.other-month):hover { 
            background-color: #e9ecef; 
            border-color: #ced4da; /* Border on hover */
        }
        .calendar-day.selected-leave { /* Style for selected days */
            background-color: var(--primary-color) !important; 
            color: white !important; 
            transform: scale(1.1); 
            font-weight: bold;
        }
        .other-month { 
            color: #adb5bd; 
            cursor: default; 
            background-color: transparent !important; /* Override hover if other-month */
            border: 1px solid transparent; /* ensure it has a border base too */
        }
        .weekend { 
            color: #6c757d; /* Slightly darker than holidays, to differentiate */
        }
        .holiday { 
            background-color: var(--info-bg); 
            color: var(--info-color); 
            font-weight: bold;
        }
        #simulationResult { 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #f8f9fa; 
            border-radius: 8px; 
            text-align: left; /* align simulation results */
        }
        .sim-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 5px 0; 
            border-bottom: 1px solid var(--border-color); 
        }
        .sim-row:last-child { 
            border-bottom: none; 
        }
        .sim-label { 
            font-weight: 600; 
            color: var(--header-color); /* Make labels stand out */
        }
        .sim-value { 
            font-weight: 500; /* slightly bolder values */
        }
        .sim-value.warning { 
            color: var(--warning-color); 
        }
        .sim-value.safe { 
            color: var(--safe-color); 
        }

        /* Timetable Card */
        .timetable-card table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
        }
        .timetable-card th, .timetable-card td { 
            padding: 8px; 
            text-align: left; 
            border: 1px solid var(--border-color); 
        }
        .timetable-card th { 
            background-color: var(--light-grey); 
            font-weight: 600; 
            color: var(--header-color); 
        }
        .timetable-card td.day-header { 
            font-weight: 700; 
            color: var(--header-color); 
            background-color: var(--card-bg); 
        }
        .timetable-card td.subject-time { 
            font-size: 0.9em; 
            color: var(--dark-grey); 
        }

        /* Summary Card */
        .summary-card .analysis-item, .summary-card .insight { 
            margin-bottom: 10px; 
        }
        .summary-card .insight { 
            margin-top: 15px; 
        }
        .summary-card .progress-bar { 
            margin-top: 5px; 
        }

        .icon { 
            vertical-align: middle; 
            margin-right: 8px; 
            width: 20px; 
            height: 20px; 
            fill: currentColor; /* Ensure icons use text color */
        }
        .copyright {
            text-align: center; 
            margin-top: 30px; 
            padding-top: 20px;
            border-top: 1px solid var(--border-color); 
            font-size: 0.9em;
            color: var(--dark-grey); 
            font-style: italic;
        }

        /* --- Timetable Management Styles --- */
        #timatableEditorSection {
            background-color: var(--light-grey);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        #timatableEditorSection h4 {
            margin-top: 0;
            color: var(--header-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .current-entry-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95em;
        }
        .current-entry-row:last-child {
            border-bottom: none;
        }
        .current-entry-row div:first-child {
            flex-grow: 1;
            margin-right: 15px;
        }
        .current-entry-row button {
            margin-left: 8px;
            padding: 5px 10px; /* Smaller padding for inline buttons */
        }

        /* Ensure existing hidden class works well */
        .hidden {
            display: none !important;
        }

        /* --- RESPONSIVE DESIGN STYLES --- */
        @media (max-width: 850px) {
            .container { 
                padding: 20px 15px; 
            }
            .dashboard { 
                grid-template-columns: 1fr; /* Stack cards vertically */
            }
            header h1 { 
                font-size: 1.8em; 
            }
            .input-section { 
                flex-direction: column; 
                align-items: stretch; 
            }
            .input-section button { 
                width: 100%; 
            }
        }

        @media (max-width: 480px) {
            header h1 { 
                font-size: 1.5em; 
            }
            header p { 
                font-size: 0.9em; 
            }
            .card { 
                padding: 15px; 
            }
            .card h3 { 
                font-size: 1.1em; 
            }
            .gauge-container { 
                width: 180px; 
                height: 90px; 
            }
            .gauge-svg { 
                width: 180px; 
                height: 90px; 
            }
            .gauge-text { 
                font-size: 2.2em; 
            }
            .subject-row { 
                grid-template-columns: 80px 1fr 45px; 
                font-size: 0.85em; 
            }
            .calendar-day { 
                width: 28px; 
                height: 28px; 
                font-size: 0.8em; 
            }
            .day-name { 
                font-size: 0.8em; 
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Advanced Attendance Dashboard</h1>
        <p>Arpit Mishra here is your tool for tracking attendance, simulating leaves, and achieving your academic goals.</p>
    </header>
    
    <div class="input-section">
        <div class="input-group">
            <label for="classesHeld">Total Classes Held So Far</label>
            <input type="number" id="classesHeld" placeholder="e.g., 150">
        </div>
        <div class="input-group">
            <label for="classesAttended">Total Classes You Attended</label>
            <input type="number" id="classesAttended" placeholder="e.g., 120">
        </div>
        <button id="calculateBtn" class="btn-primary">Generate Dashboard</button>
    </div>

    <main id="dashboard" class="dashboard">
        <!-- Left Column -->
        <div class="card">
            <h3>
                <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 4,12A8,8 0 0,1 12,20A8,8 0 0,1 12,4M12,12.5A1.5,1.5 0 0,1 10.5,11A1.5,1.5 0 0,1 12,9.5A1.5,1.5 0 0,1 13.5,11A1.5,1.5 0 0,1 12,12.5M17,11.5C17,13.43 14.77,15 12,15C9.23,15 7,13.43 7,11.5C7,9.57 9.23,8 12,8C14.77,8 17,9.57 17,11.5Z" /></svg>
                Overall Attendance
            </h3>
            <div class="gauge-container">
                <svg class="gauge-svg" viewBox="0 0 100 50">
                    <path class="gauge-back" d="M10 50 A 40 40 0 0 1 90 50" stroke-width="20"></path>
                    <path id="gaugeFront" class="gauge-front" d="M10 50 A 40 40 0 0 1 90 50" stroke-width="20"></path>
                </svg>
                <div id="gaugeText" class="gauge-text">-</div>
            </div>
            <p id="gaugeSubtext" class="gauge-subtext">-</p>
        </div>

        <div class="card">
            <h3>
                <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>
                Strategic Analysis
            </h3>
            <div id="analysisContent"></div>
        </div>
        
        <!-- New Card: Summary of Attendance & Leave -->
        <div class="card summary-card">
            <h3>
                <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,19.2C9.24,19.2 6.71,17.37 6.23,14.72L8.78,14.29C9.04,16.16 10.78,17.35 12.5,17.35C14.22,17.35 15.96,16.16 16.22,14.29L18.77,14.72C18.29,17.37 15.76,19.2 12,19.2M12,10.9C10.85,10.9 9.78,10.34 9.01,9.47L7.09,11.39L6.5,10.8L8.52,8.78C7.65,8.01 7.09,6.94 7.09,5.8C7.09,3.75 8.75,2 10.8,2C12.85,2 14.5,3.75 14.5,5.8C14.5,7.85 12.85,9.5 10.8,9.5C11.3,9.5 11.8,9.4 12.27,9.27L14.09,11.09C13.22,11.77 12.7,11.41 12,10.9M10.8,4C9.9,4 9.2,4.7 9.2,5.8C9.2,6.9 9.9,7.6 10.8,7.6C11.7,7.6 12.4,6.9 12.4,5.8C12.4,4.7 11.7,4 10.8,4Z"/></svg>
                Attendance Summary
            </h3>
            <div id="summaryContent"></div>
        </div>

        <!-- Right Column -->
        <div class="card">
            <h3>
                <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3,13H11V11H3M3,6V8H21V6M3,18H11V16H3M13,16H21V18H13M13,11H21V13H13M13,6V8H21V6Z" /></svg>
                Simulated Subject Breakdown
            </h3>
            <div id="subjectBreakdown"></div>
            <small style="display:block; text-align:center; margin-top:10px; color:var(--dark-grey);"><i>*This is an estimation based on your overall percentage.</i></small>
        </div>

        <div class="card">
             <h3>
                <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,19H5V8H19M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M16.53,11.06L15.47,10L10.5,14.97L8.47,12.94L7.41,14L10.5,17.09L16.53,11.06Z" /></svg>
                Leave & Holiday Planner
            </h3>
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prevMonthBtn" class="btn-secondary" style="padding: 8px 12px;">◄</button>
                    <h4 id="monthYear"></h4>
                    <button id="nextMonthBtn" class="btn-secondary" style="padding: 8px 12px;">►</button>
                </div>
                <div class="calendar-grid">
                    <div class="day-name">S</div><div class="day-name">M</div><div class="day-name">T</div>
                    <div class="day-name">W</div><div class="day-name">T</div><div class="day-name">F</div><div class="day-name">S</div>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
            <div id="simulationResult"></div>
        </div>

        <!-- New Card for Timetable Management -->
        <div class="card">
            <h3>
                <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,19H5V8H19M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M16.53,11.06L15.47,10L10.5,14.97L8.47,12.94L7.41,14L10.5,17.09L16.53,11.06Z" /></svg>
                Timetable Management
            </h3>
            <div id="timatableEditorSection">
                <button id="toggleTimetableEditorBtn" class="btn-primary" style="width: 100%; margin-bottom: 15px;">Manage Timetable Entries</button>
                
                <div id="timatableEditorContainer" class="hidden">
                    <div id="currentTimetableEntriesDisplay" style="margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
                        <!-- Current timetable entries will be rendered here -->
                    </div>
                    
                    <div id="editTimetableEntryForm" style="margin-top: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f8f9fa;">
                        <h4><span id="formMode">Add</span> Timetable Entry</h4>
                        <div class="input-group">
                            <label for="editSubjectName">Subject Name:</label>
                            <input type="text" id="editSubjectName" class="input-style">
                        </div>
                        <div class="input-group">
                            <label for="editSubjectDays">Days (comma-separated, e.g., Mon, Tue, Wed):</label>
                            <input type="text" id="editSubjectDays" class="input-style" placeholder="Mon, Wed">
                        </div>
                        <div class="input-group">
                            <label for="editSubjectTimes">Times (comma-separated, matching days):</label>
                            <input type="text" id="editSubjectTimes" class="input-style" placeholder="9:30 AM - 10:30 AM, 2:30 PM - 3:30 PM">
                        </div>
                        <input type="hidden" id="editEntryIndex"> <!-- Stores index for editing, -1 for new -->
                        <div style="margin-top: 15px;">
                            <button id="saveTimetableEntryBtn" class="btn-primary">Save Entry</button>
                            <button id="cancelTimetableEditBtn" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                    <button id="showAddTimetableEntryFormBtn" class="btn-primary" style="width: 100%; margin-top: 15px;">Add New Timetable Entry</button>
                </div>
            </div>
        </div>
        
        <!-- Existing Timetable Card -->
        <div class="card timetable-card">
            <h3>
                <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M7,1H17A2,2 0 0,1 19,3V21A2,2 0 0,1 17,23H7A2,2 0 0,1 5,21V3A2,2 0 0,1 7,2M7,2A1,1 0 0,0 6,3V17H18V3A1,1 0 0,0 17,2H7Z" /></svg>
                Your Timetable
            </h3>
            <table>
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Time</th>
                        <th>Subject</th>
                    </tr>
                </thead>
                <tbody id="timetableBody">
                    <!-- Timetable rows will be populated by JS -->
                </tbody>
            </table>
        </div>

    </main>
    
    <footer class="copyright">
        <p>&copy; 2025 | Made by Arpit Mishra</p>
    </footer>
</div>

<script>
    // --- CONFIGURATION --- //
    const REQUIRED_ATTENDANCE_PERCENT = 75;
    // Classes held per day of the week (0: Sunday, 6: Saturday)
    const CLASSES_PER_DAY = { 0: 0, 1: 4, 2: 4, 3: 5, 4: 5, 5: 4, 6: 0 }; 

    // Variable declaration changed to `let` to allow modification
    let SUBJECTS_TIMETABLE_INFO = [
        { subject: "Strategic Management", days: ["Mon", "Tue", "Wed", "Thu"], times: ["9:30 AM - 10:30 AM", "9:30 AM - 10:30 AM", "9:30 AM - 10:30 AM", "9:30 AM - 10:30 AM"] },
        { subject: "Universal Human Value", days: ["Mon", "Fri"], times: ["10:30 AM - 11:30 AM", "9:30 AM - 10:30 AM"] },
        { subject: "IFM", days: ["Mon", "Tue", "Wed", "Thu"], times: ["11:30 AM - 12:30 PM", "11:30 AM - 12:30 PM", "11:30 AM - 12:30 PM", "11:30 AM - 12:30 PM"] },
        { subject: "Finance", days: ["Mon", "Wed", "Thu", "Fri"], times: ["3:30 PM - 4:30 PM", "3:30 PM - 4:30 PM", "2:30 PM - 3:30 PM", "1:30 PM - 2:30 PM"] },
        { subject: "Security Analysis", days: ["Tue", "Wed", "Thu", "Fri"], times: ["10:30 AM - 11:30 AM", "10:30 AM - 11:30 AM", "10:30 AM - 11:30 AM", "10:30 AM - 11:30 AM"] },
        { subject: "Digital Marketing", days: ["Tue", "Wed", "Thu", "Fri"], times: ["3:30 PM - 4:30 PM", "2:30 PM - 3:30 PM", "12:30 PM - 1:30 PM", "12:30 PM - 1:30 PM"] }
    ];

    // Define academic period (August 1, 2025 to December 31, 2025)
    const ACADEMIC_START_DATE_OBJ = new Date(2025, 7, 1); // Month is 0-indexed (7 = August)
    const ACADEMIC_END_DATE_OBJ = new Date(2025, 11, 31); // 11 = December

    // Define holidays with dates in 'YYYY-MM-DD' format for easy lookup
    const HOLIDAYS = { 
        '2025-08-09': 'Raksha Bandhan', 
        '2025-08-15': 'Independence Day', 
        '2025-08-16': 'Janmashtami', 
        '2025-10-02': 'Gandhi Jayanti', 
        '2025-10-07': 'Valmiki Jayanti', 
        '2025-10-20': 'Deepawali', 
        '2025-10-21': 'Deepawali', 
        '2025-10-22': 'Deepawali', 
        '2025-10-23': 'Deepawali', 
        '2025-11-05': 'Guru Nanak B\'day', 
        '2025-12-25': 'Christmas' 
    };
    
    // --- DOM ELEMENT MAPPING --- //
    // This object will hold references to all frequently used DOM elements.
    const allDomElements = {
        // Dashboard Elements
        heldInput: document.getElementById('classesHeld'),
        attendedInput: document.getElementById('classesAttended'),
        calculateBtn: document.getElementById('calculateBtn'),
        dashboard: document.getElementById('dashboard'),
        gaugeFront: document.getElementById('gaugeFront'),
        gaugeText: document.getElementById('gaugeText'),
        gaugeSubtext: document.getElementById('gaugeSubtext'),
        analysisContent: document.getElementById('analysisContent'),
        summaryContent: document.getElementById('summaryContent'),
        subjectBreakdown: document.getElementById('subjectBreakdown'),
        
        // Calendar Elements
        prevMonthBtn: document.getElementById('prevMonthBtn'),
        nextMonthBtn: document.getElementById('nextMonthBtn'),
        monthYearEl: document.getElementById('monthYear'),
        calendarGrid: document.getElementById('calendarGrid'),
        simulationResult: document.getElementById('simulationResult'),
        
        // Timetable Display
        timetableBody: document.getElementById('timetableBody'),

        // Timetable Management Elements
        toggleTimetableEditorBtn: document.getElementById('toggleTimetableEditorBtn'),
        timatableEditorContainer: document.getElementById('timatableEditorContainer'),
        currentTimetableEntriesDisplay: document.getElementById('currentTimetableEntriesDisplay'),
        editTimetableEntryForm: document.getElementById('editTimetableEntryForm'),
        editSubjectName: document.getElementById('editSubjectName'),
        editSubjectDays: document.getElementById('editSubjectDays'),
        editSubjectTimes: document.getElementById('editSubjectTimes'),
        editEntryIndex: document.getElementById('editEntryIndex'), // Hidden input for index
        saveTimetableEntryBtn: document.getElementById('saveTimetableEntryBtn'),
        cancelTimetableEditBtn: document.getElementById('cancelTimetableEditBtn'),
        showAddTimetableEntryFormBtn: document.getElementById('showAddTimetableEntryFormBtn'),
        formMode: document.getElementById('formMode'), // For "Add" or "Edit" label
    };

    // --- CONSTANTS --- //
    // For the SVG gauge, radius is 40. The semicircle path length is PI * r.
    // The stroke-dasharray and offset work on the path length.
    const gaugeCircumference = Math.PI * 40; 

    // --- STATE --- //
    let calendarNavDate; // Stores the current month/year being displayed in the calendar.
    let inputDataDate;   // Stores the date up to which 'held' and 'attended' are valid ("as of" date).
    let selectedLeaveDates = new Set(); // Stores selected leave dates as 'YYYY-MM-DD' strings.
    let held = 0, attended = 0; // User input for classes held and attended.
    let totalClassesInAcademicPeriod = 0; // Pre-calculated total classes in the academic term.
    let totalWorkingDaysInAcademicPeriod = 0; // Pre-calculated total working days (Mon-Fri, excluding holidays) in the academic term.

    let currentEditingIndex = -1; // State for timetable management form: -1 for adding, >=0 for editing

    // --- HELPER FUNCTIONS --- //
    
    /**
     * Formats a Date object into a 'YYYY-MM-DD' string.
     * @param {Date} date The date to format.
     * @returns {string} The formatted date string.
     */
    function formatDate(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0); // Normalize time to start of day
        return d.toISOString().split('T')[0];
    }

    /**
     * Counts the total number of classes held within a date range, 
     * based on the CLASSES_PER_DAY configuration.
     * @param {Date} startDate The start of the period.
     * @param {Date} endDate The end of the period.
     * @returns {number} The total number of classes.
     */
    function countClassesBetweenDates(startDate, endDate) {
        let totalClasses = 0;
        let current = new Date(startDate);
        current.setHours(0,0,0,0); // Normalize time to start of day

        while (current <= endDate) {
            const dayOfWeek = current.getDay(); // 0 for Sunday, 6 for Saturday
            totalClasses += CLASSES_PER_DAY[dayOfWeek] || 0; 
            current.setDate(current.getDate() + 1); // Move to the next day
        }
        return totalClasses;
    }

    /**
     * Counts the number of working days (Monday-Friday) within a date range,
     * excluding any dates specified in the HOLIDAYS object.
     * @param {Date} startDate The start of the period.
     * @param {Date} endDate The end of the period.
     * @returns {number} The total number of working days.
     */
    function countWorkingDaysBetweenDates(startDate, endDate) {
         let workingDays = 0;
         let current = new Date(startDate);
         current.setHours(0,0,0,0); // Normalize time

         while (current <= endDate) {
             const dayOfWeek = current.getDay();
             const formattedCurrentDate = formatDate(current);
             // Count if it's Mon-Fri and NOT a holiday
             if (dayOfWeek !== 0 && dayOfWeek !== 6 && !HOLIDAYS[formattedCurrentDate]) {
                 workingDays++;
             }
             current.setDate(current.getDate() + 1); // Move to the next day
         }
         return workingDays;
    }

    /**
     * Calculates the average number of classes per working day.
     * Handles division by zero if there are no working days.
     * @returns {number} The average classes per working day.
     */
    function getAvgClassesPerWorkingDay() {
        if (totalWorkingDaysInAcademicPeriod > 0) {
            return totalClassesInAcademicPeriod / totalWorkingDaysInAcademicPeriod;
        }
        return 0; 
    }

    // --- INITIALIZATION --- //
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        today.setHours(0,0,0,0); // Normalize today's date

        // Set the initial date for calendar navigation.
        if (today < ACADEMIC_START_DATE_OBJ) {
            calendarNavDate = new Date(ACADEMIC_START_DATE_OBJ); 
        } else {
            calendarNavDate = new Date(today); // Use a copy of today's date
        }
        
        // Pre-calculate total classes and working days in the academic period
        totalClassesInAcademicPeriod = countClassesBetweenDates(ACADEMIC_START_DATE_OBJ, ACADEMIC_END_DATE_OBJ);
        totalWorkingDaysInAcademicPeriod = countWorkingDaysBetweenDates(ACADEMIC_START_DATE_OBJ, ACADEMIC_END_DATE_OBJ);
        
        renderCalendar(); // Render calendar for the initial month.
        populateTimetable(); // Populate the timetable card with the static schedule.
        
        // Attach event listeners to interactive elements.
        allDomElements.calculateBtn.addEventListener('click', generateDashboard);
        allDomElements.prevMonthBtn.addEventListener('click', () => changeMonth(-1)); // Previous month
        allDomElements.nextMonthBtn.addEventListener('click', () => changeMonth(1));  // Next month
        
        // Timetable Management Event Listeners
        allDomElements.toggleTimetableEditorBtn.addEventListener('click', () => {
            const isHidden = allDomElements.timatableEditorContainer.classList.contains('hidden');
            if (isHidden) {
                allDomElements.timatableEditorContainer.classList.remove('hidden');
                allDomElements.toggleTimetableEditorBtn.textContent = 'Hide Timetable Management';
                renderCurrentTimetableEntries(); // Render entries when editor is shown
            } else {
                allDomElements.timatableEditorContainer.classList.add('hidden');
                allDomElements.toggleTimetableEditorBtn.textContent = 'Manage Timetable Entries';
                hideTimetableForm(); // Ensure form is hidden if container is hidden
            }
        });

        allDomElements.showAddTimetableEntryFormBtn.addEventListener('click', () => {
            showTimetableForm(-1); // Show form for adding new entry
        });

        allDomElements.saveTimetableEntryBtn.addEventListener('click', saveTimetableEntry);
        allDomElements.cancelTimetableEditBtn.addEventListener('click', hideTimetableForm);

        // Event delegation for editing and deleting current entries
        allDomElements.currentTimetableEntriesDisplay.addEventListener('click', (event) => {
            const target = event.target;
            const index = parseInt(target.dataset.index);

            if (target.classList.contains('btn-edit-timetable')) {
                showTimetableForm(index); // Show form for editing
            } else if (target.classList.contains('btn-delete-timetable')) {
                deleteTimetableEntry(index);
            }
        });

        // Initial render of timetable entries when page loads
        renderCurrentTimetableEntries(); 
    });

    // --- CORE FUNCTIONS --- //

    /**
     * Triggered when the "Generate Dashboard" button is clicked.
     * Reads input values, performs validation, sets the reference date, 
     * makes the dashboard visible, and updates all components.
     */
    function generateDashboard() {
        const heldInputVal = allDomElements.heldInput.value;
        const attendedInputVal = allDomElements.attendedInput.value;

        held = parseInt(heldInputVal);
        attended = parseInt(attendedInputVal);

        // Input validation
        if (isNaN(held) || isNaN(attended) || held < 0 || attended < 0 || attended > held) {
            alert("Please enter valid numbers. Ensure 'Classes Attended' is not more than 'Total Classes Held'.");
            return; // Exit function if validation fails
        }
        
        // Set the reference date for the input data.
        const today = new Date();
        today.setHours(0,0,0,0); // Normalize today's date to midnight

        if (today < ACADEMIC_START_DATE_OBJ) {
            inputDataDate = new Date(ACADEMIC_START_DATE_OBJ);
        } else {
            inputDataDate = new Date(today); // Use a copy of today's date
        }
        
        // Make the main dashboard area visible
        allDomElements.dashboard.style.display = 'grid';
        
        // Call the function to update all dashboard components
        updateAllComponents();
    }

    /**
     * Updates all visual components of the dashboard based on current state.
     */
    function updateAllComponents() {
        if (held === 0 && attended === 0) { 
            updateGauge(0); 
            updateAnalysis(0, 0, 0);
            updateSubjectBreakdown(0); 
            updateSummary(0, 0, 0);
            updateSimulation(); // Show initial message
            return; 
        }
        
        let percentage = 0;
        if (held > 0) {
            percentage = (attended / held) * 100;
        } else if (attended === 0) {
            percentage = 0;
        }
        if (!isFinite(percentage)) {
            percentage = 0; // Default to 0 if calculation results in NaN or Infinity.
        }
        
        updateGauge(percentage);
        updateAnalysis(percentage, held, attended);
        updateSubjectBreakdown(percentage); 
        updateSummary(percentage, held, attended);
        updateSimulation(); // Update the simulation section
    }

    /**
     * Updates the SVG gauge visualization with the given attendance percentage.
     * @param {number} percentage The overall attendance percentage (0-100).
     */
    function updateGauge(percentage) {
        const effectivePercentage = Math.min(100, Math.max(0, percentage));
        
        const offset = gaugeCircumference * (1 - (effectivePercentage / 100));
        
        allDomElements.gaugeFront.style.strokeDasharray = gaugeCircumference;
        allDomElements.gaugeFront.style.strokeDashoffset = offset;
        
        const requiredColor = percentage >= REQUIRED_ATTENDANCE_PERCENT ? 'var(--safe-color)' : 'var(--warning-color)';
        allDomElements.gaugeFront.style.stroke = requiredColor;
        
        allDomElements.gaugeText.textContent = `${effectivePercentage.toFixed(1)}%`;
        allDomElements.gaugeSubtext.textContent = `${attended} / ${held} Classes`;
    }
    
    /**
     * Updates the "Strategic Analysis" card content.
     * @param {number} percentage Current overall attendance percentage.
     * @param {number} currentHeld Total classes held according to input.
     * @param {number} currentAttended Total classes attended according to input.
     */
    function updateAnalysis(percentage, currentHeld, currentAttended) {
        let content = '';
        const avgClassesPerWorkingDay = getAvgClassesPerWorkingDay(); 

        if (percentage >= REQUIRED_ATTENDANCE_PERCENT || (currentHeld === 0 && currentAttended === 0)) {
            const missableClasses = (currentHeld === 0) ? "∞" : Math.max(0, Math.floor(currentAttended / (REQUIRED_ATTENDANCE_PERCENT / 100) - currentHeld));
            const practicalDaysStr = (currentHeld === 0 || missableClasses === "∞" || avgClassesPerWorkingDay === 0) 
                                    ? "N/A" 
                                    : (missableClasses / avgClassesPerWorkingDay).toFixed(1);

            content = `
                <div class="analysis-item" style="color:var(--safe-color); font-weight:bold;">STATUS: SAFE</div>
                <div class="analysis-item"><strong>Attendance Buffer:</strong> You can afford to miss <strong>${missableClasses}</strong> more classes before dropping below 75%.</div>
                <div class="analysis-item"><strong>In Practical Terms:</strong> This is roughly equivalent to <strong>${practicalDaysStr}</strong> full days of leave.</div>
                <div class="insight"><strong>Tip:</strong> You have a healthy buffer. Use it wisely for emergencies or important events. Don't let your attendance drift down without reason.</div>
            `;
        } 
        else { // WARNING Status
            const targetAttendedFor75PercentOfHeld = REQUIRED_ATTENDANCE_PERCENT / 100 * currentHeld;
            const classesNeededToReach75 = Math.max(0, Math.ceil(targetAttendedFor75PercentOfHeld - currentAttended)); 
            
            const missableClasses = Math.max(0, Math.floor(currentAttended / (REQUIRED_ATTENDANCE_PERCENT / 100) - currentHeld));
            const practicalDaysStr = (currentHeld === 0 || missableClasses === "∞" || avgClassesPerWorkingDay === 0) 
                                    ? "N/A" 
                                    : (missableClasses / avgClassesPerWorkingDay).toFixed(1);

            content = `
                <div class="analysis-item" style="color:var(--warning-color); font-weight:bold;">STATUS: WARNING</div>
                <div class="analysis-item"><strong>Classes to Recover:</strong> You must attend the next <strong>${classesNeededToReach75}</strong> classes without absence to reach 75%.</div>
                <div class="analysis-item"><strong>Attendance Buffer:</strong> You can afford to miss <strong>${missableClasses}</strong> more classes before dropping to 75%.</div>
                <div class="analysis-item"><strong>In Practical Terms:</strong> This is roughly equivalent to <strong>${practicalDaysStr}</strong> full days of leave.</div>
                <div class="insight"><strong>Tip:</strong> Prioritize attending every class. Each full day of attendance (~${avgClassesPerWorkingDay > 0 ? avgClassesPerWorkingDay.toFixed(1) : 'N/A'} classes) will significantly help close this gap.</div>
            `;
        }
        allDomElements.analysisContent.innerHTML = content;
    }

    /**
     * Updates the "Attendance Summary" card.
     */
    function updateSummary(currentPercentage, currentHeld, currentAttended) {
        let summaryContent = '';
        const avgClassesPerWorkingDay = getAvgClassesPerWorkingDay();

        let classesNeededToReach75 = 0;
        let estimatedDaysToRecover = 'N/A'; 
        
        if (currentHeld > 0 && currentPercentage < REQUIRED_ATTENDANCE_PERCENT) {
            const targetAttendedFor75PercentOfHeld = REQUIRED_ATTENDANCE_PERCENT / 100 * currentHeld;
            classesNeededToReach75 = Math.max(0, Math.ceil(targetAttendedFor75PercentOfHeld - currentAttended));
            
            if (avgClassesPerWorkingDay > 0) { 
                estimatedDaysToRecover = (classesNeededToReach75 / avgClassesPerWorkingDay).toFixed(1);
            } else {
                estimatedDaysToRecover = 'Cannot calculate (no working days)';
            }
        }
        
        const targetMinClassesForPeriod = Math.ceil(REQUIRED_ATTENDANCE_PERCENT / 100 * totalClassesInAcademicPeriod);
        const maxMissableClassesInPeriod = totalClassesInAcademicPeriod - targetMinClassesForPeriod;
        
        let maxLeaveDaysAllowance = 'N/A'; 
        if (avgClassesPerWorkingDay > 0) { 
            maxLeaveDaysAllowance = (maxMissableClassesInPeriod / avgClassesPerWorkingDay).toFixed(1);
        } else {
            maxLeaveDaysAllowance = 'Cannot calculate (no working days)';
        }
        
        summaryContent += `
            <div class="analysis-item">
                <strong>Current Status:</strong> ${currentPercentage.toFixed(1)}% (${currentAttended}/${currentHeld} classes)
            </div>
        `;

        if (currentHeld > 0) {
             summaryContent += `
                <div class="analysis-item">
                    <strong>Days to Reach 75%:</strong> ${classesNeededToReach75} classes needed (~ ${estimatedDaysToRecover} days if attending all classes)
                </div>
            `;
        } else {
             summaryContent += `
                <div class="analysis-item">
                    <strong>Days to Reach 75%:</strong> Enter class data to see recovery time.
                </div>
            `;
        }

        summaryContent += `
            <div class="analysis-item">
                <strong>Total Classes in Period:</strong> ${totalClassesInAcademicPeriod}
            </div>
            <div class="analysis-item">
                <strong>Max Leave Days Allowed:</strong> ~${maxLeaveDaysAllowance} days (based on 75% attendance)
            </div>
            <div class="insight">
                <strong>Insight:</strong> Plan your leaves considering your overall allowance and recovery needs.
            </div>
        `;
        
        allDomElements.summaryContent.innerHTML = summaryContent;
    }

    /**
     * Updates the "Simulated Subject Breakdown" card. (Placeholder function)
     */
    function updateSubjectBreakdown(percentage) {
        if (percentage > 0) {
             allDomElements.subjectBreakdown.innerHTML = `<p><em>Subject breakdown based on overall attendance: ${percentage.toFixed(1)}%.</em></p>`;
        } else {
             allDomElements.subjectBreakdown.innerHTML = `<p><em>Enter class data to see subject breakdown.</em></p>`;
        }
    }

    /**
     * Populates the timetable card with class schedules.
     */
    function populateTimetable() {
        allDomElements.timetableBody.innerHTML = ''; // Clear any existing rows
        const daysOfWeek = ["Mon", "Tue", "Wed", "Thu", "Fri"]; 

        daysOfWeek.forEach(day => {
            const classesForDay = SUBJECTS_TIMETABLE_INFO.filter(item => item.days.includes(day));
            
            if (classesForDay.length === 0) {
                allDomElements.timetableBody.innerHTML += `
                    <tr>
                        <td class="day-header">${day}</td>
                        <td colspan="2">No classes scheduled</td>
                    </tr>
                `;
            } else { 
                classesForDay.forEach((classInfo, index) => {
                    const dayIndex = classInfo.days.indexOf(day); 
                    const time = classInfo.times[dayIndex];
                    allDomElements.timetableBody.innerHTML += `
                        <tr>
                            <td class="day-header">${index === 0 ? day : ''}</td>
                            <td class="subject-time">${time}</td>
                            <td>${classInfo.subject}</td>
                        </tr>
                    `;
                });
            }
        });
    }

    /**
     * Renders the calendar grid for the month specified by `calendarNavDate`.
     */
    function renderCalendar() {
        allDomElements.calendarGrid.innerHTML = ''; // Clear previous month's calendar grid.
        const year = calendarNavDate.getFullYear();
        const month = calendarNavDate.getMonth();
        
        allDomElements.monthYearEl.textContent = `${calendarNavDate.toLocaleString('default', { month: 'long' })} ${year}`;
        
        const firstDayOfMonth = new Date(year, month, 1).getDay(); 
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            allDomElements.calendarGrid.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`);
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const currentDateObj = new Date(year, month, day); 
            currentDateObj.setHours(0,0,0,0); 
            const dayOfWeek = currentDateObj.getDay();
            
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = day;
            dayEl.dataset.date = dateStr;

            if (dayOfWeek === 0 || dayOfWeek === 6) { // Weekend days
                dayEl.classList.add('weekend');
            }
            if (HOLIDAYS[dateStr]) { // If the current date is a defined holiday.
                dayEl.classList.add('holiday');
                dayEl.title = HOLIDAYS[dateStr]; 
            }
            if (selectedLeaveDates.has(dateStr)) {
                dayEl.classList.add('selected-leave');
            }
            
            if (currentDateObj < ACADEMIC_START_DATE_OBJ || currentDateObj > ACADEMIC_END_DATE_OBJ) {
                dayEl.classList.add('other-month');
                dayEl.style.cursor = 'default';
            } else {
                dayEl.addEventListener('click', handleDateClick);
            }
            allDomElements.calendarGrid.appendChild(dayEl); 
        }
    }

    /**
     * Handles click events on calendar days.
     */
    function handleDateClick(event) {
        if (allDomElements.dashboard.style.display !== 'grid') {
             alert('Please generate the dashboard first by entering class details!');
             return;
        }

        const dateStr = event.target.dataset.date;
        if (!dateStr) return;

        const leaveDateObj = new Date(dateStr);
        leaveDateObj.setHours(0,0,0,0);

        if (leaveDateObj < ACADEMIC_START_DATE_OBJ || leaveDateObj > ACADEMIC_END_DATE_OBJ) {
            return;
        }

        if (selectedLeaveDates.has(dateStr)) {
            selectedLeaveDates.delete(dateStr); 
            event.target.classList.remove('selected-leave'); 
        } else {
            selectedLeaveDates.add(dateStr); 
            event.target.classList.add('selected-leave'); 
        }
        updateSimulation();
    }

    /**
     * Navigates the calendar to the previous or next month.
     */
    function changeMonth(offset) {
        calendarNavDate.setMonth(calendarNavDate.getMonth() + offset);
        renderCalendar();
    }

    /**
     * Updates the "Leave & Holiday Planner" simulation result area.
     */
    function updateSimulation() {
        if (allDomElements.dashboard.style.display !== 'grid') {
            allDomElements.simulationResult.innerHTML = `<p><em>Select dates on the calendar to plan your leave and see the impact.</em></p>`;
            return;
        }

        let classesMissedThisPeriod = 0;
        let workingLeaveDaysCount = 0;
        
        const simulationStartDate = inputDataDate || ACADEMIC_START_DATE_OBJ; 

        selectedLeaveDates.forEach(dateStr => {
            const leaveDate = new Date(dateStr);
            leaveDate.setHours(0,0,0,0);

            if (leaveDate > simulationStartDate) {
                const dayOfWeek = leaveDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !HOLIDAYS[dateStr]) {
                    classesMissedThisPeriod += CLASSES_PER_DAY[dayOfWeek] || 0;
                    workingLeaveDaysCount++; 
                }
            }
        });

        if (workingLeaveDaysCount === 0) {
             if (selectedLeaveDates.size > 0) {
                allDomElements.simulationResult.innerHTML = `<p><em>Selected leave dates are in the past or today relative to your input data. Select future dates to simulate.</em></p>`;
             } else {
                allDomElements.simulationResult.innerHTML = `<p><em>Click on calendar dates to plan a leave and see its impact.</em></p>`;
             }
             return; 
        }

        const newHeldTotal = held + classesMissedThisPeriod; 
        const newAttendedTotal = attended; 
        
        let newPercentage = 0;
        if (newHeldTotal > 0) {
            newPercentage = (newAttendedTotal / newHeldTotal) * 100;
        } else if (newAttendedTotal === 0) {
            newPercentage = 0; 
        }
        
        const oldPercentage = (held === 0) ? 0 : (attended / held) * 100;
        
        const statusClass = newPercentage >= REQUIRED_ATTENDANCE_PERCENT ? 'safe' : 'warning';
        
        allDomElements.simulationResult.innerHTML = `
            <div class="sim-row">
                <span class="sim-label">Working Leave Days Planned</span>
                <span class="sim-value">${workingLeaveDaysCount}</span>
            </div>
            <div class="sim-row">
                <span class="sim-label">Total Classes Missed (Future)</span>
                <span class="sim-value">${classesMissedThisPeriod}</span>
            </div>
            <div class="sim-row">
                <span class="sim-label">Attendance Before Simulation</span>
                <span class="sim-value">${oldPercentage.toFixed(2)}%</span>
            </div>
            <div class="sim-row">
                <span class="sim-label">Projected Attendance</span>
                <span class="sim-value ${statusClass}" style="font-weight:bold;">${newPercentage.toFixed(2)}%</span>
            </div>
        `;
    }
    
    // --- Timetable Management Logic ---

    /**
     * Renders the current list of timetable entries in the management section.
     */
    function renderCurrentTimetableEntries() {
        allDomElements.currentTimetableEntriesDisplay.innerHTML = ''; // Clear existing entries
        if (SUBJECTS_TIMETABLE_INFO.length === 0) {
            allDomElements.currentTimetableEntriesDisplay.innerHTML = '<p>No timetable entries yet. Add some!</p>';
            return;
        }

        SUBJECTS_TIMETABLE_INFO.forEach((entry, index) => {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('current-entry-row');
            rowDiv.dataset.index = index;
            rowDiv.innerHTML = `
                <div>
                    <strong>${entry.subject}</strong>
                    <div style="font-size: 0.85em; color: var(--dark-grey);">
                        Days: ${entry.days.join(', ')}<br>
                        Times: ${entry.times.join(', ')}
                    </div>
                </div>
                <div style="flex-shrink: 0;">
                    <button class="btn-edit-timetable btn-primary" data-index="${index}">Edit</button>
                    <button class="btn-delete-timetable btn-secondary" data-index="${index}">Delete</button>
                </div>
            `;
            allDomElements.currentTimetableEntriesDisplay.appendChild(rowDiv);
        });
    }

    /**
     * Shows or hides the timetable editing form, setting it up for adding or editing.
     * @param {number} index The index of the entry to edit, or -1 to add a new entry.
     */
    function showTimetableForm(index = -1) {
        allDomElements.timatableEditorContainer.classList.remove('hidden');
        allDomElements.showAddTimetableEntryFormBtn.classList.add('hidden'); // Hide the 'Add' button

        currentEditingIndex = index; // Set the index for editing or adding

        if (index === -1) { // Add Mode
            allDomElements.formMode.textContent = 'Add';
            allDomElements.editSubjectName.value = '';
            allDomElements.editSubjectDays.value = '';
            allDomElements.editSubjectTimes.value = '';
            allDomElements.editEntryIndex.value = -1;
        } else { // Edit Mode
            allDomElements.formMode.textContent = 'Edit';
            const entry = SUBJECTS_TIMETABLE_INFO[index];
            allDomElements.editSubjectName.value = entry.subject;
            allDomElements.editSubjectDays.value = entry.days.join(', ');
            allDomElements.editSubjectTimes.value = entry.times.join(', ');
            allDomElements.editEntryIndex.value = index;
        }
    }

    /**
     * Hides the timetable editing form.
     */
    function hideTimetableForm() {
        allDomElements.timatableEditorContainer.classList.add('hidden');
        allDomElements.showAddTimetableEntryFormBtn.classList.remove('hidden'); // Show the 'Add' button again
        // Clear form fields and reset index
        allDomElements.editSubjectName.value = '';
        allDomElements.editSubjectDays.value = '';
        allDomElements.editSubjectTimes.value = '';
        allDomElements.editEntryIndex.value = -1;
        allDomElements.formMode.textContent = 'Add';
    }

    /**
     * Validates the input data for a timetable entry.
     * @returns {object|boolean} Validated entry data or false if validation fails.
     */
    function validateTimetableEntry(subject, daysStr, timesStr) {
        if (!subject || subject.trim() === "") {
            alert("Subject name cannot be empty.");
            return false;
        }
        const validDays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        const days = daysStr.split(',').map(d => d.trim()).filter(d => d !== "");
        const times = timesStr.split(',').map(t => t.trim()).filter(t => t !== "");

        if (days.length === 0 || times.length === 0) {
            alert("Days and Times fields cannot be empty. Ensure they are comma-separated.");
            return false;
        }
        if (days.length !== times.length) {
            alert(`The number of days (${days.length}) must match the number of times (${times.length}).`);
            return false;
        }
        for (const day of days) {
            if (!validDays.includes(day)) {
                alert(`Invalid day format: "${day}". Please use abbreviations like Mon, Tue, etc.`);
                return false;
            }
        }
        if (times.some(time => time === "")) {
             alert("Time entries cannot be empty.");
             return false;
        }
        return { subject: subject.trim(), days, times };
    }

    /**
     * Saves the current timetable entry (either adding new or updating existing).
     */
    function saveTimetableEntry() {
        const subject = allDomElements.editSubjectName.value;
        const daysStr = allDomElements.editSubjectDays.value;
        const timesStr = allDomElements.editSubjectTimes.value;
        const index = parseInt(allDomElements.editEntryIndex.value);

        const validatedEntry = validateTimetableEntry(subject, daysStr, timesStr);
        if (!validatedEntry) {
            return; // Validation failed, message already shown.
        }

        if (index === -1) { // Adding a new entry
            SUBJECTS_TIMETABLE_INFO.push(validatedEntry);
        } else { // Editing an existing entry
            if (index >= 0 && index < SUBJECTS_TIMETABLE_INFO.length) {
                SUBJECTS_TIMETABLE_INFO[index] = validatedEntry;
            } else {
                alert("Error saving: Invalid entry index.");
                return;
            }
        }

        renderCurrentTimetableEntries(); // Update the list of entries
        populateTimetable(); // Update the displayed timetable on the dashboard
        hideTimetableForm(); // Hide the form after saving.
    }

    /**
     * Deletes a timetable entry.
     * @param {number} index The index of the entry to delete.
     */
    function deleteTimetableEntry(index) {
        if (index >= 0 && index < SUBJECTS_TIMETABLE_INFO.length) {
            if (confirm("Are you sure you want to delete this timetable entry?")) {
                SUBJECTS_TIMETABLE_INFO.splice(index, 1);
                renderCurrentTimetableEntries(); // Update the list of entries
                populateTimetable(); // Re-render main timetable
            }
        } else {
            alert("Error deleting: Invalid entry index.");
        }
    }
    
</script>
</body>
</html>```
